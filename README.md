# SQLAlchemy and Alembic Basics

## Learning Goals

- Create and persist a schema.
- Create and save your first data model.

***

## Key Vocab

- **Persist**: save a schema in a database.
- **Engine**: a Python object that translates SQL to Python and vice-versa.
- **Session**: a Python object that uses an engine to allow us to
  programmatically interact with a database.
- **Transaction**: a strategy for executing database statements such that
  the group succeeds or fails as a unit.
- **Migration**: the process of moving data from one or more databases to one
  or more target databases.

***

## What is Alembic?

Alembic is a library for handling schema changes that uses SQLAlchemy to
perform the migrations in a standardized way. Since SQLAlchemy only creates
missing tables when we use the `Base.metadata.create_all()` method, it doesn’t
update the tables to match any changes we made to the columns or keys. Alembic
provides us with classes and methods that will manage schema changes over the
course of development. Because Alembic builds upon the functionality of
SQLAlchemy, it can be used with a wide range of databases and web frameworks.

***

## Creating a Migration Environment

Earlier, we ran `alembic init migrations` command to create a
migration environment in the `migrations/` directory. This process created our
migration environment as well as an `alembic.ini` file with configuration
options for the environment. If you run `tree` in `bookstore_app/` now, you should
see this structure:

```console
.
├── alembic.ini
├── bookstore.db
├── migrations
│   ├── README
│   ├── env.py
│   ├── script.py.mako
│   └── versions
│       └── 0817994fdbf9_create_table_books.py
└── models.py
```

The `versions/` directory holds our migration scripts. `env.py` defines and
instantiates a SQLAlchemy engine, connects to that engine, starts a transaction,
and calls the migration engine. `script.py.mako` is a template that is used when
creating a migration- it defines the basic structure of a migration. We won't
need to touch that file.

***

## Generating Migrations

After we ran `alembic revision --autogenerate -m "Create table books"` earlier,
a file popped up in the `migrations/versions/` directory. Here's what you should
see inside:

```py
"""Create table books

Revision ID: 0817994fdbf9
Revises: 
Create Date: 2022-08-18 16:04:51.060065

"""
from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision = '0817994fdbf9'
down_revision = None
branch_labels = None
depends_on = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('books',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('title', sa.String(), nullable=True),
    sa.Column('author', sa.String(), nullable=True),
    sa.Column('publisher', sa.String(), nullable=True),
    sa.Column('publish_date', sa.DateTime(), nullable=True),
    sa.PrimaryKeyConstraint('id')
    )
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_table('books')
    # ### end Alembic commands ###
```

This file starts off with the message that we included with our `alembic`
command. It is important to treat these messages as you would commit messages
in Git so that other developers know when certain tables, columns, keys, and
so on were added to the database.

The `upgrade()` method includes the code that would be needed to perform
changes to the database based on this migration. Similarly, the `downgrade()`
method includes any code that would be needed to undo this migration and return
to the previous state.

After generating our migration earlier, we ran:

```console
$ alembic upgrade head
# => INFO  [alembic.runtime.migration] Context impl SQLiteImpl.
# => INFO  [alembic.runtime.migration] Will assume non-transactional DDL.
# => INFO  [alembic.runtime.migration] Running upgrade  -> 0817994fdbf9, Create table books
```

This upgraded the database to the `head`, or most recent revision.

When we make changes to data models, we can usually use Alembic
to automatically generate migrations for us and upgrade the database
accordingly.

***

## Generating a New Migration

We have a new model set up in `models.py`: `Salesperson`. (This is a book
_store_, after all.) Let's use Alembic to autogenerate a new migration:

```console
$ alembic revision --autogenerate -m 'Add table salespeople'
# => INFO  [alembic.runtime.migration] Context impl SQLiteImpl.
# => INFO  [alembic.runtime.migration] Will assume non-transactional DDL.
# => INFO  [alembic.runtime.migration] Running upgrade  -> a567je123s84, Add table salespeople
```

***

## Breakout Rooms

Let's take a minute to go into breakout rooms, discuss, and debug. When
we come back, we'll talk about using seed data with SQLAlchemy and Alembic.

***

## Resources

- [SQLAlchemy ORM Documentation][sqlaorm]
- [SQLAlchemy ORM Session Basics](https://docs.sqlalchemy.org/en/14/orm/session_basics.html)
- [SQLAlchemy ORM Column Elements and Expressions][column]
- [SQLAlchemy ORM Querying Guide](https://docs.sqlalchemy.org/en/14/orm/queryguide.html)

[column]: https://docs.sqlalchemy.org/en/14/core/sqlelement.html
[sqlaorm]: https://docs.sqlalchemy.org/en/14/orm/
